# =============================================================================
# EDG MICROSERVICES - HIGH AVAILABILITY ARCHITECTURE
# Configurazione Unica e Definitiva
# =============================================================================
# Questa è l'unica configurazione del progetto EDG.
# Include High Availability con dual API Gateway + Traefik load balancer.
# =============================================================================

networks:
  # Rete interna per comunicazione tra microservizi
  internal:
    driver: bridge
    name: edg-internal

  # Rete esterna per gateway e load balancer (accesso pubblico)
  external:
    driver: bridge
    name: edg-external

services:
  #############################################################################
  # LOAD BALANCER - Traefik
  #############################################################################
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      # API e Dashboard
      - '--api.insecure=true'
      - '--api.dashboard=true'

      # Provider Docker
      - '--providers.docker=true'
      - '--providers.docker.exposedbydefault=false'
      - '--providers.docker.network=edg-external'

      # Entrypoints
      - '--entrypoints.web.address=:80'
      - '--entrypoints.websecure.address=:443'

      # Logs
      - '--log.level=INFO'
      - '--accesslog=true'

      # Health Check
      - '--ping=true'

      # Metrics
      - '--metrics.prometheus=true'

    ports:
      - '80:80' # HTTP
      - '443:443' # HTTPS (futuro)
      - '8888:8080' # Dashboard Traefik

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    networks:
      - external

    restart: unless-stopped

    healthcheck:
      test: ['CMD', 'traefik', 'healthcheck', '--ping']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    labels:
      - 'traefik.enable=true'
      # Dashboard
      - 'traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`) || PathPrefix(`/dashboard`) || PathPrefix(`/api`)'
      - 'traefik.http.routers.traefik-dashboard.service=api@internal'
      - 'traefik.http.routers.traefik-dashboard.entrypoints=web'

  # ===========================================================================
  # DATABASE (MySQL)
  # ===========================================================================
  mysql:
    image: mysql:8.0
    container_name: auth-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - internal
    ports:
      - '3306:3306'
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      timeout: 20s
      retries: 10

  # ===========================================================================
  # DATABASE LOGGER (MongoDB)
  # ===========================================================================
  logger-mongo:
    image: mongo:7.0
    container_name: log-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_LOG_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_LOG_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_LOG_DATABASE}
    volumes:
      - mongo-data:/data/db
    networks:
      - internal
    ports:
      - '27017:27017'
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 50

  # ===========================================================================
  # AUTH SERVICE (Microservizio Autenticazione)
  # ===========================================================================
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Mode Configuration
      NODE_ENV: production
      GATEWAY_MODE: 'true'

      # Gateway Secret
      GATEWAY_SECRET: ${GATEWAY_SECRET}

      # Database
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_SYNC: 'false'

      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_EXPIRY: 15m
      JWT_REFRESH_EXPIRY: 7d

      # Service
      SERVICE_NAME: EDG Auth Service
      PORT: 3001

      # Rate Limiting
      LOGIN_RATE_LIMIT_WINDOW: 15
      LOGIN_RATE_LIMIT_MAX_ATTEMPTS: 5
      RESET_PASSWORD_RATE_LIMIT_WINDOW: 60
      RESET_PASSWORD_RATE_LIMIT_MAX_ATTEMPTS: 3
      REGISTER_RATE_LIMIT_WINDOW: 60
      REGISTER_RATE_LIMIT_MAX_ATTEMPTS: 10

      # Logging
      LOG_LEVEL: info
    expose:
      - '3001'
    networks:
      - internal
    healthcheck:
      test: ['CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://localhost:3001/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # LOG SERVICE (Microservizio Logger)
  # ===========================================================================
  log-service:
    build:
      context: ./log-service
      dockerfile: Dockerfile
    container_name: log-service
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://logger-mongo:27017/edglogger
      - MONGO_HOST=logger-mongo
      - MONGO_PORT=27017
      - MONGO_DATABASE=edglogger
    depends_on:
      - logger-mongo
    networks:
      - internal
    restart: unless-stopped

  # ===========================================================================
  # FRONTEND PRO (Operatori)
  # ===========================================================================
  pro-frontend:
    build:
      context: ./pro-frontend
      dockerfile: Dockerfile
      target: frontend-dev
    container_name: pro-frontend
    restart: unless-stopped
    volumes:
      - ./pro-frontend:/app
      - /app/node_modules
      - /app/dist
    environment:
      - NODE_ENV=development
    networks:
      - internal
    ports:
      - '5173:5173'
    stdin_open: true
    tty: true
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:5173']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # FRONTEND APP (Clienti)
  # ===========================================================================
  app-frontend:
    build:
      context: ./app-frontend
      dockerfile: Dockerfile
      target: frontend-dev
    container_name: app-frontend
    restart: unless-stopped
    volumes:
      - ./app-frontend:/app
      - /app/node_modules
      - /app/dist
    environment:
      - NODE_ENV=development
      - VITE_FRONTEND_TYPE=app
    networks:
      - internal
    ports:
      - '5174:5174'
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:5174']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # FRONTEND EDG (Partner)
  # ===========================================================================
  edg-frontend:
    build:
      context: ./edg-frontend
      dockerfile: Dockerfile
      target: frontend-dev
    container_name: edg-frontend
    restart: unless-stopped
    volumes:
      - ./edg-frontend:/app
      - /app/node_modules
      - /app/dist
    environment:
      - NODE_ENV=development
      - VITE_FRONTEND_TYPE=edg
    networks:
      - internal
    ports:
      - '5175:5175'
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:5175']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  #############################################################################
  # API GATEWAY - Istanza 1 (Primary)
  #############################################################################
  api-gateway-1:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway-1
    hostname: api-gateway-1
    restart: unless-stopped
    depends_on:
      auth-service:
        condition: service_healthy
      pro-frontend:
        condition: service_healthy
      app-frontend:
        condition: service_healthy
      edg-frontend:
        condition: service_healthy
    environment:
      # Gateway Configuration
      NODE_ENV: production
      PORT: 8080

      # Service URLs
      AUTH_SERVICE_URL: http://auth-service:3001
      FRONTEND_PRO_URL: http://pro-frontend:5173
      FRONTEND_APP_URL: http://app-frontend:5174
      FRONTEND_EDG_URL: http://edg-frontend:5175

      # JWT Secret
      JWT_SECRET: ${JWT_SECRET}

      # Gateway Secret
      GATEWAY_SECRET: ${GATEWAY_SECRET}

      # CORS Origins
      CORS_ORIGINS: ${CORS_ORIGINS}

      # Rate Limiting
      RATE_LIMIT_WINDOW: 15
      RATE_LIMIT_MAX_ATTEMPTS: 100

      # Instance Identifier
      INSTANCE_ID: gateway-1

    networks:
      - internal
      - external

    healthcheck:
      test: ['CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

    labels:
      - 'traefik.enable=true'

      # Router HTTP
      - 'traefik.http.routers.api-gateway.rule=PathPrefix(`/`)'
      - 'traefik.http.routers.api-gateway.entrypoints=web'
      - 'traefik.http.routers.api-gateway.service=api-gateway'

      # Service con Load Balancing
      - 'traefik.http.services.api-gateway.loadbalancer.server.port=8080'
      - 'traefik.http.services.api-gateway.loadbalancer.server.scheme=http'

      # Health Check per Load Balancer
      - 'traefik.http.services.api-gateway.loadbalancer.healthcheck.path=/health'
      - 'traefik.http.services.api-gateway.loadbalancer.healthcheck.interval=10s'
      - 'traefik.http.services.api-gateway.loadbalancer.healthcheck.timeout=5s'

  #############################################################################
  # API GATEWAY - Istanza 2 (Secondary)
  #############################################################################
  api-gateway-2:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway-2
    hostname: api-gateway-2
    restart: unless-stopped
    depends_on:
      auth-service:
        condition: service_healthy
      pro-frontend:
        condition: service_healthy
      app-frontend:
        condition: service_healthy
      edg-frontend:
        condition: service_healthy
    environment:
      # Gateway Configuration
      NODE_ENV: production
      PORT: 8080

      # Service URLs (identici a gateway-1)
      AUTH_SERVICE_URL: http://auth-service:3001
      FRONTEND_PRO_URL: http://pro-frontend:5173
      FRONTEND_APP_URL: http://app-frontend:5174
      FRONTEND_EDG_URL: http://edg-frontend:5175

      # JWT Secret (IDENTICO a gateway-1)
      JWT_SECRET: ${JWT_SECRET}

      # Gateway Secret (IDENTICO a gateway-1)
      GATEWAY_SECRET: ${GATEWAY_SECRET}

      # CORS Origins
      CORS_ORIGINS: ${CORS_ORIGINS}

      # Rate Limiting
      RATE_LIMIT_WINDOW: 15
      RATE_LIMIT_MAX_ATTEMPTS: 100

      # Instance Identifier
      INSTANCE_ID: gateway-2

    networks:
      - internal
      - external

    healthcheck:
      test: ['CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

    labels:
      - 'traefik.enable=true'

      # Stesso router di gateway-1 (load balancing automatico)
      - 'traefik.http.routers.api-gateway.rule=PathPrefix(`/`)'
      - 'traefik.http.routers.api-gateway.entrypoints=web'
      - 'traefik.http.routers.api-gateway.service=api-gateway'

      # Service
      - 'traefik.http.services.api-gateway.loadbalancer.server.port=8080'
      - 'traefik.http.services.api-gateway.loadbalancer.server.scheme=http'

      # Health Check
      - 'traefik.http.services.api-gateway.loadbalancer.healthcheck.path=/health'
      - 'traefik.http.services.api-gateway.loadbalancer.healthcheck.interval=10s'
      - 'traefik.http.services.api-gateway.loadbalancer.healthcheck.timeout=5s'

volumes:
  mysql-data:
    driver: local
  mongo-data:
    driver: local
# =============================================================================
# ARCHITETTURA HIGH AVAILABILITY
# =============================================================================
#
#                          ┌─────────────┐
#                          │   Traefik   │ :80, :443, :8888
#                          │    (LB)     │
#                          └──────┬──────┘
#                                 │
#                 ┌───────────────┴───────────────┐
#                 │                               │
#          ┌──────▼──────┐                 ┌──────▼──────┐
#          │  Gateway 1  │                 │  Gateway 2  │
#          │   :8080     │                 │   :8080     │
#          └──────┬──────┘                 └──────┬──────┘
#                 │                               │
#                 └───────────────┬───────────────┘
#                                 │
#        ┌────────────────────────┼────────────────────────┐
#        │                        │                        │
#   ┌────▼─────┐         ┌────────▼────────┐      ┌──────▼──────┐
#   │Auth Svc  │         │   3 Frontends   │      │  Databases  │
#   │  :3001   │         │ :5173/:5174/:5175│     │ MySQL/Mongo │
#   └──────────┘         └─────────────────┘      └─────────────┘
#
# =============================================================================
# COMANDI PRINCIPALI
# =============================================================================
#
# Avvio sistema:
#   docker-compose up -d
#
# Stop sistema:
#   docker-compose down
#
# Stato container:
#   docker-compose ps
#
# Logs (tutti):
#   docker-compose logs -f
#
# Logs (specifico):
#   docker-compose logs -f traefik
#   docker-compose logs -f api-gateway-1
#   docker-compose logs -f api-gateway-2
#
# Rebuild immagini:
#   docker-compose build
#   docker-compose up -d --build
#
# Restart singolo servizio:
#   docker-compose restart api-gateway-1
#
# =============================================================================
# ENDPOINTS
# =============================================================================
#
# • HTTP (Load Balanced):    http://localhost/
# • Health Check:             http://localhost/health
# • Traefik Dashboard:        http://localhost:8888/dashboard/
# • Pro Frontend (direct):    http://localhost:5173
# • App Frontend (direct):    http://localhost:5174
# • EDG Frontend (direct):    http://localhost:5175
# • MySQL:                    localhost:3306
# • MongoDB:                  localhost:27017
#
# =============================================================================
# VANTAGGI HIGH AVAILABILITY
# =============================================================================
#
# ✅ Zero downtime - Un gateway può crashare senza interrompere il servizio
# ✅ Load balancing - Distribuzione automatica del carico tra i due gateway
# ✅ Health check - Traefik esclude automaticamente gateway non healthy
# ✅ Scalabilità - Facile aggiungere più gateway se necessario
# ✅ Monitoring - Dashboard Traefik per vedere traffico in real-time
# ✅ Production-ready - Stessa architettura in sviluppo e produzione
#
# =============================================================================
